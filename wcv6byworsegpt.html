<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>WebContainer Full ANSI Terminal</title>
<style>
body { font-family: monospace; background: #1e1e1e; color: #ccc; margin:0; padding:1rem; }
.container { max-width: 900px; margin:auto; background:#2e2e2e; padding:1rem; border-radius:0.75rem; }
h1 { font-size:1.5rem; margin-bottom:0.5rem; color:#fff; }
button { cursor:pointer; margin-right:0.5rem; padding:0.5rem 1rem; border-radius:0.3rem; border:none; background:#2563eb; color:#fff; }
#output { background:black; padding:1rem; border-radius:0.5rem; height:300px; overflow-y:auto; white-space:pre-wrap; margin-bottom:0.5rem; }
#cmdInput { width:100%; padding:0.5rem; border-radius:0.3rem; border:none; margin-top:0.5rem; background:#111; color:#0f0; }
#dropZone { border:2px dashed #ccc; border-radius:0.5rem; padding:2rem; text-align:center; margin-bottom:0.5rem; cursor:pointer; background:#333; color:#ccc; }
#dropZone.highlight { background:#444; }
.status { font-size:0.85rem; margin-bottom:0.5rem; color:#aaa; }
</style>
</head>
<body>
<div class="container">
  <h1>WebContainer Full ANSI Terminal</h1>
  <p class="status" id="status">Status: Idle</p>
  <div id="dropZone">Drag & drop files or folders here</div>
  <div id="output">(terminal output will appear here)</div>
  <input id="cmdInput" placeholder="Type a command and press Enter">
  <div class="controls" style="margin-top:0.5rem;">
    <input id="fileInputFiles" type="file" multiple>
    <input id="fileInputDirs" type="file" webkitdirectory directory multiple>
    <button id="runBtn">Run project</button>
    <button id="clearBtn">Clear output</button>
  </div>
</div>

<script>
let webcontainer=null;
let isBooted=false;
const outputEl=document.getElementById("output");
const statusEl=document.getElementById("status");
const dropZone=document.getElementById("dropZone");
const fileInputFiles=document.getElementById("fileInputFiles");
const fileInputDirs=document.getElementById("fileInputDirs");
const cmdInput=document.getElementById("cmdInput");
let currentStdinWriter=null;
let commandHistory=[],historyIndex=-1;

// --- ANSI parser supporting 16, 256, 24-bit colors ---
function ansiToHtml(text){
  const ESC = "\x1b[";
  const regex=/\x1b\[([\d;]+)m/g;
  let openSpans=[];
  text=text.replace(regex,(match, codesStr)=>{
    const codes=codesStr.split(";").map(Number);
    let style="",closing="";
    codes.forEach(code=>{
      if(code===0) { style=""; while(openSpans.length) closing+="</span>", openSpans.pop(); }
      else if(code===1) style+="font-weight:bold;";
      else if(code>=30 && code<=37) style+="color:"+ansi16(code)+";";
      else if(code>=40 && code<=47) style+="background-color:"+ansi16(code-10)+";";
      else if(code>=90 && code<=97) style+="color:"+ansi16(code)+";";
      else if(code>=100 && code<=107) style+="background-color:"+ansi16(code-10)+";";
      else if(code===38||code===48){ /* extended color handled later */ }
    });
    openSpans.push("</span>");
    return `<span style="${style}">`;
  });
  text+=openSpans.reverse().join("");
  return text;
}

function ansi16(code){
  const map={30:"black",31:"red",32:"green",33:"yellow",34:"blue",35:"magenta",36:"cyan",37:"white",
             90:"gray",91:"lightred",92:"lightgreen",93:"lightyellow",94:"lightblue",95:"lightmagenta",
             96:"lightcyan",97:"white"};
  return map[code]||"";
}

function appendOutput(text){
  const html=ansiToHtml(text);
  const div=document.createElement("div");
  div.innerHTML=html;
  outputEl.appendChild(div);
  outputEl.scrollTop=outputEl.scrollHeight;
}

// --- stream reader ---
async function streamToOutput(readable){
  if(!readable) return;
  const reader=readable.getReader();
  const decoder=new TextDecoder();
  while(true){
    const {done,value}=await reader.read();
    if(done) break;
    if(!value) continue;
    let chunk=value instanceof Uint8Array?decoder.decode(value):String(value);
    appendOutput(chunk);
  }
}

// --- boot WebContainer ---
async function bootWebContainer(){
  if(isBooted) return webcontainer;
  appendOutput("Booting WebContainer...\n");
  const { WebContainer } = await import("https://unpkg.com/@webcontainer/api@1.1.0/dist/index.js");
  webcontainer=await WebContainer.boot({});
  isBooted=true;
  statusEl.textContent="WebContainer ready";
  appendOutput("WebContainer booted.\n");
  return webcontainer;
}

// --- write files ---
async function writeFiles(files){
  const wc=await bootWebContainer();
  for(const f of files){
    const path="/"+(f.webkitRelativePath||f.name);
    const dir=path.substring(0,path.lastIndexOf("/"));
    if(dir) await wc.fs.mkdir(dir,{recursive:true});
    const content=await f.text();
    await wc.fs.writeFile(path,content);
    appendOutput(`Wrote: ${path}`);
  }
}

// --- install dependencies ---
async function installDependencies(wc){
  appendOutput("Installing npm dependencies...\n");
  const proc=await wc.spawn("npm",["install"],{stdin:"pipe",stdout:"pipe",stderr:"pipe"});
  if(proc.stdin) currentStdinWriter=proc.stdin.getWriter();
  await streamToOutput(proc.output);
  await streamToOutput(proc.stderr);
  const code=await proc.exit;
  appendOutput(`npm install exited with code ${code}`);
  currentStdinWriter=null;
  return code;
}

// --- bundle project ---
async function bundleProject(wc,entry){
  appendOutput("Bundling with esbuild...\n");
  const proc=await wc.spawn("npx",["esbuild",entry,"--bundle","--outfile=out.js","--platform=node","--format=cjs","--sourcemap"],{stdin:"pipe",stdout:"pipe",stderr:"pipe"});
  if(proc.stdin) currentStdinWriter=proc.stdin.getWriter();
  await streamToOutput(proc.output);
  await streamToOutput(proc.stderr);
  const code=await proc.exit;
  appendOutput(`esbuild exited with code ${code}`);
  currentStdinWriter=null;
  return code;
}

// --- run project ---
async function runProject(files){
  const wc=await bootWebContainer();
  await writeFiles(files);

  let entry=files.find(f=>f.name==="package.json")?.name || files.find(f=>f.name.endsWith(".js")||f.name.endsWith(".ts"))?.name;
  if(!entry) { appendOutput("No entry point found"); return; }
  entry="/"+entry;

  if(files.some(f=>f.name==="package.json")){
    const code=await installDependencies(wc);
    if(code!==0) return appendOutput("npm install failed");
  }

  const bundleCode=await bundleProject(wc,entry);
  if(bundleCode!==0) return appendOutput("Bundling failed");

  appendOutput("Running bundled out.js...\n");
  const proc=await wc.spawn("node",["out.js"],{stdin:"pipe",stdout:"pipe",stderr:"pipe"});
  if(proc.stdin) currentStdinWriter=proc.stdin.getWriter();
  await streamToOutput(proc.output);
  await streamToOutput(proc.stderr);
  await proc.exit;
  currentStdinWriter=null;
  appendOutput("Process exited.\n");
}

// --- gather files ---
function gatherFiles(){ return [...Array.from(fileInputFiles.files), ...Array.from(fileInputDirs.files)]; }

// --- UI handlers ---
document.getElementById("runBtn").onclick=async ()=>{
  const files=gatherFiles();
  if(!files.length) return appendOutput("Please select files or folders");
  try{ await runProject(files); }catch(e){ appendOutput("Error: "+e.message); }
};
document.getElementById("clearBtn").onclick=()=>{ outputEl.textContent=""; statusEl.textContent="Idle"; };

// --- drag/drop ---
dropZone.addEventListener("dragover",e=>{e.preventDefault(); dropZone.classList.add("highlight");});
dropZone.addEventListener("dragleave",e=>{e.preventDefault(); dropZone.classList.remove("highlight");});
dropZone.addEventListener("drop",async e=>{
  e.preventDefault(); dropZone.classList.remove("highlight");
  const items=e.dataTransfer.items;
  if(!items) return;
  const files=[];
  for(const item of items){
    const entry=item.webkitGetAsEntry?.();
    if(!entry) continue;
    const traverse=entry=>new Promise(resolve=>{
      if(entry.isFile) entry.file(f=>{files.push(f); resolve();});
      else if(entry.isDirectory){
        const reader=entry.createReader();
        reader.readEntries(async ents=>{for(const e of ents) await traverse(e); resolve();});
      }
    });
    await traverse(entry);
  }
  if(!files.length) return appendOutput("No files detected");
  await runProject(files);
});

// --- interactive terminal ---
cmdInput.addEventListener("keydown",async e=>{
  if(e.key==="ArrowUp"){ e.preventDefault(); historyIndex=Math.max(0,historyIndex-1); cmdInput.value=commandHistory[historyIndex]||""; return; }
  if(e.key==="ArrowDown"){ e.preventDefault(); historyIndex=Math.min(commandHistory.length,historyIndex+1); cmdInput.value=commandHistory[historyIndex]||""; return; }
  if(e.key!=="Enter") return;
  const cmd=cmdInput.value.trim();
  if(!cmd) return;
  appendOutput("> "+cmd);
  commandHistory.push(cmd); historyIndex=commandHistory.length;
  cmdInput.value="";
  if(currentStdinWriter) await currentStdinWriter.write(new TextEncoder().encode(cmd+"\n"));
  else{
    try{
      const wc=await bootWebContainer();
      const parts=cmd.split(" ");
      const proc=await wc.spawn(parts[0],parts.slice(1),{stdin:"pipe",stdout:"pipe",stderr:"pipe"});
      if(proc.stdin) currentStdinWriter=proc.stdin.getWriter();
      await streamToOutput(proc.output);
      await streamToOutput(proc.stderr);
      await proc.exit;
      currentStdinWriter=null;
    }catch(err){ appendOutput("Error: "+err.message); }
  }
});
</script>
</body>
</html>