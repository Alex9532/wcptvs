<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebContainer Runner (Interactive)</title>
  <style>
    body { font-family: monospace; background: #111; color: #eee; margin: 0; padding: 1rem; }
    .container { max-width: 900px; margin: auto; background: #1e1e1e; padding: 1rem; border-radius: 0.5rem; }
    h1 { font-size: 1.2rem; color: #90caf9; margin-bottom: 1rem; }
    .controls { margin-bottom: 1rem; display: flex; flex-wrap: wrap; gap: 0.5rem; align-items: center; }
    .btn { padding: 0.4rem 0.8rem; background: #333; border: 1px solid #555; border-radius: 0.3rem; cursor: pointer; color: #eee; }
    .btn-primary { background: #1976d2; border-color: #1976d2; color: white; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    #dropZone { border: 2px dashed #444; border-radius: 0.5rem; padding: 1rem; text-align: center; color: #aaa; margin-bottom: 1rem; }
    #dropZone.highlight { background: #222; border-color: #90caf9; color: #90caf9; }
    .output { background: #000; color: #eee; font-family: monospace; padding: 1rem; border-radius: 0.3rem; height: 400px; overflow-y: auto; white-space: pre-wrap; }
    .terminal { display: flex; margin-top: 0.5rem; }
    #cmdInput { flex: 1; padding: 0.4rem; background: #111; color: #eee; border: 1px solid #444; border-radius: 0.3rem; font-family: monospace; }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebContainer Runner (Interactive)</h1>
    <div id="dropZone">Drag & drop files or folders here</div>

    <div class="controls">
      <label>Files: <input id="fileInputFiles" type="file" multiple></label>
      <label>Folders: <input id="fileInputDirs" type="file" webkitdirectory directory multiple></label>
      <label><input type="checkbox" id="bundleCheckbox"> Use esbuild bundling</label>
      <button id="runBtn" class="btn btn-primary">Run Project</button>
      <button id="clearBtn" class="btn">Clear Output</button>
    </div>

    <div id="output" class="output">(terminal output will appear here)</div>

    <div class="terminal">
      <input id="cmdInput" type="text" placeholder="Type commands here (press Enter)">
    </div>
  </div>

  <script type="module">
    import { WebContainer } from "https://unpkg.com/@webcontainer/api@1.1.0/dist/index.js";

    let webcontainer = null;
    let isBooted = false;
    let currentStdinWriter = null;
    const outputEl = document.getElementById("output");
    const cmdInput = document.getElementById("cmdInput");
    const fileInputFiles = document.getElementById("fileInputFiles");
    const fileInputDirs = document.getElementById("fileInputDirs");
    const dropZone = document.getElementById("dropZone");

    // --- Append output safely ---
    function appendOutput(text) {
      outputEl.innerHTML += ansiToHtml(text);
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    // --- Basic ANSI color parsing ---
    function ansiToHtml(str) {
      return str
        .replace(/\u001b\[0m/g, "</span>")
        .replace(/\u001b\[31m/g, '<span style="color:#f44336">')
        .replace(/\u001b\[32m/g, '<span style="color:#4caf50">')
        .replace(/\u001b\[33m/g, '<span style="color:#ffeb3b">')
        .replace(/\u001b\[34m/g, '<span style="color:#2196f3">')
        .replace(/\u001b\[35m/g, '<span style="color:#e91e63">')
        .replace(/\u001b\[36m/g, '<span style="color:#00bcd4">');
    }

    // --- WebContainer boot ---
    async function bootWebContainer() {
      if (isBooted) return webcontainer;
      appendOutput("Booting WebContainer...\n");
      webcontainer = await WebContainer.boot();
      isBooted = true;
      appendOutput("âœ… WebContainer booted.\n");
      return webcontainer;
    }

    // --- Stream output safely ---
    async function streamToOutput(stream) {
      if (!stream) return;
      const reader = stream.getReader();
      const decoder = new TextDecoder();
      while (true) {
        const { value, done } = await reader.read();
        if (done) break;
        if (value) appendOutput(decoder.decode(value));
      }
    }

    async function installDependencies(wc) {
      appendOutput("ðŸ“¦ Installing dependencies...\n");
      const proc = await wc.spawn("npm", ["install"], { stdin: "pipe" });
      currentStdinWriter = proc.stdin.getWriter();
      streamToOutput(proc.output);
      streamToOutput(proc.stderr);
      const exitCode = await proc.exit;
      appendOutput("npm install exited with code " + exitCode + "\n");
      currentStdinWriter = null;
      return exitCode;
    }

    async function bundleProject(wc, entry) {
      appendOutput("âš™ï¸ Bundling with esbuild...\n");
      const proc = await wc.spawn("npx", [
        "esbuild", entry,
        "--bundle", "--outfile=out.js",
        "--platform=node", "--format=cjs", "--sourcemap"
      ]);
      streamToOutput(proc.output);
      streamToOutput(proc.stderr);
      const exitCode = await proc.exit;
      appendOutput("esbuild exited with code " + exitCode + "\n");
      return exitCode;
    }

    async function runProject(files) {
      const wc = await bootWebContainer();

      // Write all files
      for (const f of files) {
        const path = "/" + (f.webkitRelativePath || f.name);
        const dir = path.substring(0, path.lastIndexOf("/"));
        if (dir) await wc.fs.mkdir(dir, { recursive: true });
        await wc.fs.writeFile(path, await f.text());
        appendOutput(`Wrote: ${path}\n`);
      }

      // Ensure package.json
      const pkgFile = files.find(f => f.name === "package.json");
      if (!pkgFile) {
        appendOutput("No package.json found â€” creating one...\n");
        const defaultPkg = {
          name: "webcontainer-project",
          version: "1.0.0",
          main: "index.js",
          scripts: { start: "node index.js" }
        };
        await wc.fs.writeFile("/package.json", JSON.stringify(defaultPkg, null, 2));
      }

      // npm install
      const code = await installDependencies(wc);
      if (code !== 0) return appendOutput("âš ï¸ npm install failed.\n");

      // Determine entry
      let entry = "/index.js";
      const jsFiles = files.map(f => "/" + (f.webkitRelativePath || f.name)).filter(p => p.endsWith(".js"));
      if (jsFiles.length && !jsFiles.includes(entry)) entry = jsFiles[0];
      appendOutput(`Detected entry: ${entry}\n`);

      // Optional bundling
      const bundleCheckbox = document.getElementById("bundleCheckbox");
      if (bundleCheckbox.checked) {
        const bundleExit = await bundleProject(wc, entry);
        if (bundleExit !== 0) return appendOutput("Bundling failed.\n");
        entry = "/out.js";
      }

      // Run with npm start
      appendOutput("ðŸš€ Starting project with npm start...\n");
      const runProc = await wc.spawn("npm", ["start"], { stdin: "pipe" });
      currentStdinWriter = runProc.stdin.getWriter();
      streamToOutput(runProc.output);
      streamToOutput(runProc.stderr);
      runProc.exit.then(() => {
        appendOutput("\n[process exited]\n");
        currentStdinWriter = null;
      });
    }

    async function gatherFiles() {
      return [...Array.from(fileInputFiles.files), ...Array.from(fileInputDirs.files)];
    }

    document.getElementById("runBtn").onclick = async () => {
      const files = await gatherFiles();
      if (!files.length) return appendOutput("No files selected.\n");
      try { await runProject(files); } catch (e) { appendOutput("Error: " + e.message + "\n"); }
    };

    document.getElementById("clearBtn").onclick = () => { outputEl.innerHTML = ""; };

    // Drag & Drop
    dropZone.addEventListener("dragover", e => { e.preventDefault(); dropZone.classList.add("highlight"); });
    dropZone.addEventListener("dragleave", e => { e.preventDefault(); dropZone.classList.remove("highlight"); });
    dropZone.addEventListener("drop", async e => {
      e.preventDefault();
      dropZone.classList.remove("highlight");
      const files = [...e.dataTransfer.files];
      if (!files.length) return appendOutput("No files dropped.\n");
      await runProject(files);
    });

    // Terminal input
    const history = [];
    let histIndex = 0;

    cmdInput.addEventListener("keydown", async e => {
      if (e.key === "ArrowUp") {
        if (history.length && histIndex > 0) {
          histIndex--;
          cmdInput.value = history[histIndex];
        }
        return;
      }
      if (e.key === "ArrowDown") {
        if (histIndex < history.length - 1) {
          histIndex++;
          cmdInput.value = history[histIndex];
        } else {
          cmdInput.value = "";
          histIndex = history.length;
        }
        return;
      }
      if (e.key === "Enter") {
        const cmd = cmdInput.value.trim();
        if (!cmd) return;
        history.push(cmd);
        histIndex = history.length;
        cmdInput.value = "";
        if (currentStdinWriter) {
          await currentStdinWriter.write(new TextEncoder().encode(cmd + "\n"));
        } else {
          const wc = await bootWebContainer();
          const proc = await wc.spawn("bash", { stdin: "pipe", stdout: "pipe", stderr: "pipe" });
          currentStdinWriter = proc.stdin.getWriter();
          streamToOutput(proc.output);
          streamToOutput(proc.stderr);
          await currentStdinWriter.write(new TextEncoder().encode(cmd + "\n"));
          proc.exit.then(() => {
            appendOutput("\n[process exited]\n");
            currentStdinWriter = null;
          });
        }
      }
    });
  </script>
</body>
</html>
