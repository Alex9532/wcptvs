<!--
WebContainer File Runner (Vanilla JS + HTML + CSS)
This version replicates the React component as a standalone HTML app.
-->

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WebContainer File Runner</title>
  <style>
    body { font-family: sans-serif; background: #f9fafb; margin: 0; padding: 2rem; }
    .container { max-width: 768px; margin: auto; background: white; padding: 1.5rem; border-radius: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    h1 { font-size: 1.5rem; margin-bottom: 1rem; }
    p { font-size: 0.9rem; color: #555; }
    button { cursor: pointer; margin-right: 0.5rem; }
    .btn { padding: 0.5rem 1rem; border-radius: 0.5rem; border: 1px solid #ccc; background: #f3f4f6; }
    .btn-primary { background: #2563eb; color: white; border: none; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .output { background: black; color: #22c55e; font-family: monospace; padding: 1rem; border-radius: 0.5rem; height: 16rem; overflow: auto; white-space: pre-wrap; }
    .status { font-size: 0.75rem; color: #666; margin: 0.5rem 0; }
    .error { font-size: 0.9rem; color: red; margin: 0.5rem 0; }
  </style>
</head>
<body>
  <div class="container">
    <h1>WebContainer File Runner</h1>
    <p>Upload a JavaScript (.js) file and execute it inside a WebContainer (Node runtime in-browser).</p>

    <div style="margin-bottom: 1rem; display: flex; gap: 0.5rem; align-items: center;">
      <input id="fileInput" type="file" accept=".js">
      <button id="runBtn" class="btn btn-primary">Run uploaded file</button>
      <button id="helloBtn" class="btn">Run sample: hello.js</button>
      <button id="errorBtn" class="btn">Run sample: error.js</button>
      <button id="clearBtn" class="btn" style="margin-left:auto;">Clear output</button>
    </div>

    <div class="status" id="status">Status: Idle</div>
    <div class="error" id="errorMsg"></div>
    <div class="output" id="output">(terminal output will appear here)</div>

    <div class="status">
      <strong>Security notice:</strong> this runs inside an in-browser container provided by WebContainer.
    </div>
  </div>

  <script>
    let webcontainer = null;
    let isBooted = false;
    let running = false;

    const outputEl = document.getElementById("output");
    const statusEl = document.getElementById("status");
    const errorEl = document.getElementById("errorMsg");
    const fileInput = document.getElementById("fileInput");

    function appendOutput(text) {
      outputEl.textContent += text;
      outputEl.scrollTop = outputEl.scrollHeight;
    }

    async function bootWebContainer() {
      if (isBooted) return webcontainer;
      appendOutput("Booting WebContainer...\n");
      try {
        const url = "https://unpkg.com/@webcontainer/api@1.1.0/dist/index.js";
        // @vite-ignore
        const { WebContainer } = await import(/* webpackIgnore: true */ url);
        const wc = await WebContainer.boot({});
        webcontainer = wc;
        isBooted = true;
        statusEl.textContent = "Status: WebContainer ready";
        appendOutput("WebContainer booted.\n");
        return wc;
      } catch (err) {
        const msg = err.message || String(err);
        errorEl.textContent = "Last error: " + msg;
        appendOutput("Failed to boot WebContainer: " + msg + "\n");
        throw err;
      }
    }

    async function writeSkeletonProject(wc) {
      await wc.fs.writeFile("/package.json", JSON.stringify({ name: "webcontainer-runner", version: "1.0.0" }, null, 2));
    }

    async function runFileInWebContainer(filename, content) {
      errorEl.textContent = "";
      const wc = await bootWebContainer();
      try {
        await writeSkeletonProject(wc);
        const path = "/" + filename;
        await wc.fs.writeFile(path, content);
        appendOutput("Wrote file to WebContainer: " + path + "\n");
        appendOutput("Starting node " + filename + "...\n");
        running = true;

        const proc = await wc.spawn("node", [filename]);
        proc.output.pipeTo(new WritableStream({
          write(chunk) { appendOutput(new TextDecoder().decode(chunk)); }
        }));

        const exitCode = await proc.exit;
        appendOutput("\nProcess exited with code " + exitCode + "\n");
      } catch (err) {
        appendOutput("Error: " + (err.message || String(err)) + "\n");
      } finally {
        running = false;
      }
    }

    document.getElementById("runBtn").onclick = async () => {
      if (!fileInput.files.length) {
        appendOutput("Please choose a .js file first.\n");
        return;
      }
      const file = fileInput.files[0];
      if (!file.name.endsWith(".js")) {
        appendOutput("Only .js files supported.\n");
        return;
      }
      const text = await file.text();
      await runFileInWebContainer(file.name, text);
    };

    document.getElementById("helloBtn").onclick = () => {
      appendOutput("\n--- Running sample: hello.js ---\n");
      runFileInWebContainer("hello.js", `console.log("Hello from WebContainer!");`);
    };

    document.getElementById("errorBtn").onclick = () => {
      appendOutput("\n--- Running sample: error.js ---\n");
      runFileInWebContainer("error.js", `console.log('About to throw'); throw new Error('This is a test error from error.js');`);
    };

    document.getElementById("clearBtn").onclick = () => {
      outputEl.textContent = "";
      errorEl.textContent = "";
    };
  </script>
</body>
</html>
