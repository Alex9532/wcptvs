// --- persistent terminal process ---
let terminalProc = null;
let terminalStdin = null;

// helper to spawn a persistent terminal (bash) if none exists
async function ensureTerminal() {
  if (terminalProc) return terminalProc;
  const wcInst = await bootWebContainer();
  terminalProc = await safeSpawn('bash', [], { stdin: 'pipe', stdout: 'pipe', stderr: 'pipe' });
  if (terminalProc.stdin) terminalStdin = terminalProc.stdin.getWriter();
  streamToOutput(terminalProc.output);
  streamToOutput(terminalProc.stderr);
  terminalProc.exit.then(code => {
    appendOutput(`\n[terminal exited with ${code}]\n`);
    terminalProc = null;
    terminalStdin = null;
  });
  return terminalProc;
}

// intercept cmdInput
cmdInput.addEventListener('keydown', async e => {
  if (e.key === 'Enter') {
    const cmd = cmdInput.value;
    cmdInput.value = '';
    if (!cmd.trim()) return;
    appendOutput('$ ' + cmd + '\n');

    // add to history
    if (cmd.trim()) {
      cmdHistory.push(cmd);
      histIndex = cmdHistory.length;
    }

    try {
      await ensureTerminal();
      if (terminalStdin) {
        await terminalStdin.write(new TextEncoder().encode(cmd + '\n'));
      }
    } catch (err) {
      appendOutput('Terminal input error: ' + (err?.message || err) + '\n');
    }
  }

  // history navigation
  if (e.key === 'ArrowUp') {
    if (!cmdHistory.length) return;
    histIndex = Math.max(0, histIndex - 1);
    cmdInput.value = cmdHistory[histIndex] || '';
    e.preventDefault();
  }
  if (e.key === 'ArrowDown') {
    if (!cmdHistory.length) return;
    histIndex = Math.min(cmdHistory.length, histIndex + 1);
    cmdInput.value = cmdHistory[histIndex] || '';
    e.preventDefault();
  }
});
